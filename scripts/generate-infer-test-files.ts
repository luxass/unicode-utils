/* eslint-disable node/prefer-global/process */
import { existsSync, readdirSync } from "node:fs";
import { writeFile } from "node:fs/promises";
import { join } from "node:path";
import { dedent } from "@luxass/utils";

const COMMENT = dedent`
/**
 * This file is auto-generated by scripts/generate-infer-test-file.ts
 * Do not edit it manually.
 * To regenerate, run the script with:
 *  pnpm run generate:infer-test-file
 */
`;

async function run() {
  const ucdFilesDir = join(process.cwd(), "ucd-files");

  // read ucd-files for versions
  const versions = readdirSync(ucdFilesDir, { withFileTypes: true })
    .filter((entry) => entry.isDirectory())
    .map((entry) => entry.name);

  if (versions.length === 0) {
    throw new Error("No version directories found in ucd-files");
  }

  const promises = versions.map(async (version) => {
    const versionDir = join(ucdFilesDir, version);

    if (!existsSync(versionDir)) {
      throw new Error(`Version directory does not exist: ${versionDir}`);
    }

    function readFiles(dir: string): string[] {
      const entries = readdirSync(dir, { withFileTypes: true });

      const files = entries
        .filter((entry) => !entry.isDirectory())
        .map((entry) => join(dir, entry.name));

      const folders = entries
        .filter((entry) => entry.isDirectory())
        .map((entry) => join(dir, entry.name));

      const subFiles = folders.flatMap((folder) => readFiles(folder));

      return [...files, ...subFiles];
    }

    function trimVersionString(version: string): string {
      // remove trailing zeros and dots
      const trimmed = version.replace(/(\.0+)+$/, "").replace(/\.0+$/, "");
      // remove leading zeros
      return trimmed.replace(/^0+(\d)/, "$1");
    }

    const formattedVersion = trimVersionString(version);

    const files = readFiles(versionDir);

    const content = `${COMMENT}
import { describe, expect, it } from "vitest";
import { inferHeading } from "../../src/inference/heading";
import { mapUCDFiles } from "../__utils";

const ucdFiles = await mapUCDFiles("${formattedVersion}");

describe("heading inference ${formattedVersion}", async () => {
  ${files
    .filter((file) => !file.endsWith(".comments.txt"))
    .map((filePath) => {
      const fileName = filePath.replace(`${versionDir}/`, "");
      return `it("inferHeading(${fileName})", () => {
    const content = ucdFiles.file("${fileName}");
    const expected = ucdFiles.expected("${fileName}.comments.txt");

    expect(inferHeading(content)).toBe(expected);
  });`;
    })
    .join("\n\n  ")}

  it("ensure that all files have been tested", () => {
    expect(ucdFiles.files).toEqual([]);
    expect(ucdFiles.files.length).toBe(0);
  });
});\n`;

    console.log(`Test file generated: heading-${formattedVersion}.test.ts`);
    writeFile(`./test/inference/heading-${formattedVersion}.test.ts`, content, "utf-8");
  });

  await Promise.all(promises);
  console.log("All test files generated successfully.");
}

run().catch((err) => {
  console.error(err);
  process.exit(1);
});
